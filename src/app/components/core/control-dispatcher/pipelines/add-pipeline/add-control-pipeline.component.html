<div class="container is-fluid">
    <div class="navbar-item">
      <nav class="breadcrumb" aria-label="breadcrumbs">
        <ul>
          <li><a [routerLink]="['/control-dispatcher/pipelines']">Control Pipelines</a></li>
          <li class="is-active">
            <a href="#" aria-current="page">
              {{ editMode ? pipelineName : 'Add' }}
            </a>
          </li>
        </ul>
      </nav>
      <button *ngIf="editMode" (click)="getControlPipeline()" class="button is-small" id="refresh-check">
        <i class="fa fa-sm fa-sync" aria-hidden="true"></i>
      </button>
    </div>
    <div class="card">
      <div class="card-content step-content">
        <form #pipelineForm="ngForm" *ngIf="!isAddFilterWizard">
          <div class="column">
            <div [hidden]="editMode" class="field is-horizontal">
              <div class="field-label">
                <label class="label label-name">Name</label>
              </div>
              <div class="field-body">
                <div class="field">
                  <div class="control">
                      <input #name=ngModel name="name" class="input name-field" type="text" placeholder="Name" required
                       [(ngModel)]="pipelineName" title="No single quotes and double quotes!" [pattern]="QUOTATION_VALIDATION_PATTERN" autocomplete="off"
                       [ngClass]="{'is-small':rolesService.hasEditPermissions(), 'is-static static-field':!rolesService.hasEditPermissions()}"
                     [readonly]="!rolesService.hasEditPermissions()">
                  </div>
                  <div *ngIf="name.invalid && (name.dirty || name.touched)" class="help is-danger">
                    <div *ngIf="name.errors?.['required']">
                      *required
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="field is-horizontal">
              <div class="field-label">
                <label class="label label-name">Execution</label>
              </div>
              <div class="field-body">
                <div class="field" *ngIf="rolesService.hasEditPermissions();else staticExecutionDiv">
                  <div class="control">
                    <div id="execution-dropdown" class="dropdown is-left">
                      <div class="dropdown-trigger">
                        <button class="button is-small" aria-haspopup="true" aria-controls="dropdown-menu"
                          (click)="toggleDropdown('execution-dropdown')" placeholder="Select">
                          <span>{{selectedExecution}}</span>
                          <span class="icon is-small">
                            <i class="fa fa-sm fa-angle-down" aria-hidden="true"></i>
                          </span>
                        </button>
                      </div>
                      <div class="dropdown-menu" id="dropdown-menu" role="menu">
                        <div class="dropdown-content">
                            <a (click)="selectValue('Shared', 'execution');toggleDropdown('execution-dropdown')" class="dropdown-item">Shared</a>
                            <a (click)="selectValue('Exclusive', 'execution');toggleDropdown('execution-dropdown')" class="dropdown-item">Exclusive</a>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <ng-template #staticExecutionDiv>
                  <div class="field">
                    <div class="control">
                      <input name="execution" class="input" type="text" [value]="selectedExecution ? selectedExecution : 'Select Execution'"
                        [ngClass]="{'is-static static-field':!rolesService.hasEditPermissions(), 'has-text-grey-light is-size-7':!selectedExecution}"
                        [readonly]="!rolesService.hasEditPermissions()">
                    </div>
                  </div>
                </ng-template>
              </div>
            </div>

            <div class="field is-horizontal">
              <div class="field-label">
                <label class="label label-name">Source</label>
              </div>
              <div class="field-body">
                <div class="field">
                  <div class="field is-horizontal">
                    <div class="field-body">
                      <div class="field">
                        <div class="control box">
                          <div class="columns">
                            <div class="column">
                              <div class="field is-horizontal">
                                <div class="field-label is-small">
                                  <label class="label">Type</label>
                                </div>
                                <div class="field-body">
                                  <div class="field">
                                    <div class="control" *ngIf="rolesService.hasEditPermissions(); else staticSourceType">
                                      <ng-select [clearable]="false" placeholder="Select Source Type" [items]="sourceTypeList" [multiple]="false"
                                        bindLabel="name" (change)="selectValue($event, 'sourceType')"
                                        [ngModel]="selectedSourceType.name" [ngModelOptions]="{standalone: true}">
                                      </ng-select>
                                    </div>
                                    <ng-template #staticSourceType>
                                      <input name="sourceType" class="input" type="text" [value]="selectedSourceType.name ? selectedSourceType.name : 'Select Source Type'"
                                      [ngClass]="{'is-static':!rolesService.hasEditPermissions(), 'has-text-grey-light is-size-7':!selectedSourceType.name}"
                                      [readonly]="!rolesService.hasEditPermissions()">
                                    </ng-template>
                                  </div>
                                </div>
                              </div>
                              <div *ngIf="!(selectedSourceType.name === 'Any' || selectedSourceType.name === 'API')" class="field is-horizontal">
                                <div class="field-label is-small">
                                  <label class="label">Name</label>
                                </div>
                                <div class="field-body">
                                  <div class="field">
                                    <div class="control" *ngIf="rolesService.hasEditPermissions(); else staticSourceName">
                                      <ng-select [clearable]="false" placeholder="Select Source" [items]="sourceNameList" [multiple]="false"
                                        bindLabel="name" groupBy="groupbyType" (change)="selectValue($event.name, 'sourceName')"
                                        [ngModel]="selectedSourceName" [ngModelOptions]="{standalone: true}">
                                      </ng-select>
                                    </div>
                                    <div *ngIf="selectedSourceName === null && selectedSourceType" class="help is-danger">
                                      *required
                                    </div>
                                    <ng-template #staticSourceName>
                                      <input name="sourceName" class="input" type="text" [value]="selectedSourceName ? selectedSourceName : 'Select Source Name'"
                                      [ngClass]="{'is-static':!rolesService.hasEditPermissions(), 'has-text-grey-light is-size-7':!selectedSourceName}"
                                      [readonly]="!rolesService.hasEditPermissions()">
                                    </ng-template>
                                  </div>
                                </div>
                              </div>
                            </div>
                            <div class="column is-1">
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="field is-horizontal">
              <div class="field-label">
                <label class="label label-name">Destination</label>
              </div>
              <div class="field-body">
                <div class="field">
                  <div class="field is-horizontal">
                    <div class="field-body">
                      <div class="field">
                        <div class="control box">
                          <div class="columns">
                            <div class="column">
                              <div class="field is-horizontal">
                                <div class="field-label is-small">
                                  <label class="label">Type</label>
                                </div>
                                <div class="field-body">
                                  <div class="field">
                                    <div class="control" *ngIf="rolesService.hasEditPermissions(); else staticDestinationType">
                                      <ng-select [clearable]="false" placeholder="Select Destination Type" [items]="destinationTypeList" [multiple]="false"
                                        bindLabel="name" (change)="selectValue($event, 'destinationType')"
                                        [ngModel]="selectedDestinationType.name" [ngModelOptions]="{standalone: true}">
                                      </ng-select>
                                    </div>
                                    <ng-template #staticDestinationType>
                                      <input name="destinationType" class="input" type="text" [value]="selectedDestinationType.name ? selectedDestinationType.name : 'Select Destination Name'"
                                      [ngClass]="{'is-static':!rolesService.hasEditPermissions(), 'has-text-grey-light is-size-7':!selectedDestinationType.name}"
                                      [readonly]="!rolesService.hasEditPermissions()">
                                    </ng-template>
                                  </div>
                                </div>
                              </div>
                              <div *ngIf="selectedDestinationType.name !== 'Broadcast'" class="field is-horizontal">
                                <div class="field-label is-small">
                                  <label class="label">Name</label>
                                </div>
                                <div class="field-body">
                                  <div class="field">
                                    <div class="control" *ngIf="rolesService.hasEditPermissions(); else staticDestinationName">
                                      <ng-select [clearable]="false" placeholder="Select Destination" [items]="destinationNameList" [multiple]="false"
                                        bindLabel="name" groupBy="groupbyType" (change)="selectValue($event.name, 'destinationName')"
                                        [ngModel]="selectedDestinationName" [ngModelOptions]="{standalone: true}">
                                      </ng-select>
                                    </div>
                                    <div *ngIf="selectedDestinationName === null && selectedDestinationType" class="help is-danger">
                                      *required
                                    </div>
                                    <ng-template #staticDestinationName>
                                      <input name="destinationName" class="input" type="text" [value]="selectedDestinationName ? selectedDestinationName : 'Select Destination Name'"
                                      [ngClass]="{'is-static':!rolesService.hasEditPermissions(), 'has-text-grey-light is-size-7':!selectedDestinationName}"
                                      [readonly]="!rolesService.hasEditPermissions()">
                                    </ng-template>
                                  </div>
                                </div>
                              </div>
                            </div>
                            <div class="column is-1">
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="field is-horizontal">
              <div class="field-label has-text-left">
                <label class="label label-name">Filters</label>
              </div>
              <div class="field-body">
                <div class="field">
                  <div *ngIf="filterPipeline?.length > 0" class="view-content columns filter-row">
                    <div class="column filters">
                      <div class="filter-list" cdkDropList (cdkDropListDropped)="onDrop($event)">
                        <div class="accordion card" *ngFor="let filter of filterPipeline; let i = index" [attr.id]="i" cdkDrag
                          [cdkDragDisabled]="filterPipeline?.length == 1 || !rolesService.hasEditPermissions()">
                          <header class="card-header" cdkDragHandle
                            [ngClass]="{'cursor-default': filterPipeline.length < 2,'cursor-move': filterPipeline.length >= 2 && rolesService.hasEditPermissions() }">
                            <p class="card-header-title filter-name">
                              <ng-container *ngIf="filterPipeline.length > 1 && rolesService.hasEditPermissions()">
                                <i class="fa fa-xs fa-bars"></i>&nbsp;
                              </ng-container>
                              {{filter}}
                            </p>
                            <a (click)="activeAccordion(i, filter)" class="card-header-icon">
                              <span class="icon">
                                <i class="fa fa-xs fa-angle-down" aria-hidden="true"></i>
                              </span>
                            </a>
                          </header>
                          <div class="card-content" hidden>
                            <ng-container *ngIf="filterConfiguration?.key === filter">
                              <div class="field">
                                <app-configuration-group #filterConfigComponent [category]="filterConfiguration"
                                  [serviceStatus]="isPipelineEnabled" [from]="'filter-modal'" (changedConfigEvent)="getChangedFilterConfig($event)"
                                  (formStatusEvent)="validFilterConfigForm = $event">
                                </app-configuration-group>
                              </div>
                              <div class="field icon-row">
                                <div class="field has-text-left">
                                  <span class="icon is-small is-tooltip-right tooltip is-pulled-left is-hovered help-icon"
                                    data-tooltip="Help" (click)="goToLink({name: selectedFilterPlugin, type: 'Filter'})">
                                    <i class="far fa-question-circle"></i>
                                  </span>
                                </div>
                                <div class="field is-pulled-right" *ngIf="rolesService.hasEditPermissions()">
                                  <span class="icon is-small is-tooltip-left tooltip is-pulled-left is-hovered help-icon"
                                    data-tooltip="Remove" (click)="deleteFilterReference(filter)">
                                    <i class="fa fa-sm fa-trash-alt fa-lg"></i>
                                  </span>
                                </div>
                              </div>
                            </ng-container>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div [ngClass]="{'add-filter-div': !name?.value || name.invalid}">
                  <a [ngClass]="{'disabled-link': !name?.value || name.invalid}" *ngIf="filterPipeline.length > 0 && rolesService.hasEditPermissions()" (click)="openAddFilterModal(true)" class="button is-text text-btn add-filter">Add new filter</a>
                  <a [ngClass]="{'disabled-link': !name?.value || name.invalid}" *ngIf="filterPipeline.length === 0 && rolesService.hasEditPermissions()" (click)="openAddFilterModal(true, name.value)" class="button is-text text-btn add-filter">Add filter</a>
                </div>
                </div>
              </div>
            </div>
            <div class="field is-horizontal">
              <div class="field-label has-text-left">
                <label class="label label-name">Enabled</label>
              </div>
              <div class="field-body">
                <div class="field">
                  <input class="checkbox" [disabled]="!rolesService.hasEditPermissions()" type="checkbox" [checked]="isPipelineEnabled"
                    (click)="onCheckboxClicked($event)">
                </div>
              </div>
            </div>
          </div>
          <div *ngIf="rolesService.hasEditPermissions()" class="column footer-padding">
            <div class="columns">
              <div class="column is-2"></div>
              <div class="column" *ngIf="editMode">
                <div class="field is-grouped control-pad">
                  <p class="control">
                    <button (click)="openModal('confirmation-dialog')" type="button"
                      class="button is-small is-danger is-outlined">Delete</button>
                  </p>
                </div>
              </div>
              <div class="column">
                <div class="field is-grouped is-pulled-right">
                  <p class="control">
                    <button class="button is-small" type="button" (click)="onCancel()">Cancel</button>
                  </p>
                  <p class="control">
                    <button (click)="onSubmit(pipelineForm)" type="submit" class="button is-small is-link" [disabled]="name.value === '' || !name.value || pipelineForm.invalid" >Save</button>
                  </p>
                </div>
              </div>
            </div>
          </div>
        </form>
        <ng-container *ngIf="isAddFilterWizard">
          <app-add-pipeline-filter-modal [pipelineName]="pipelineName" (notify)="onNotify($event)"></app-add-pipeline-filter-modal>
        </ng-container>
      </div>
    </div>
  </div>
  <app-confirmation-dialog id="confirmation-dialog">
    <header class="modal-card-head">
      <p class="modal-card-title is-size-6">Delete</p>
      <button class="delete" aria-label="close" (click)="closeModal('confirmation-dialog')"></button>
    </header>
    <section class="modal-card-body">
      Are you sure, you want to delete the control pipeline <b>{{pipelineName}}</b>?
    </section>
    <footer class="modal-card-foot">
      <button class="button is-small" type="button" (click)="closeModal('confirmation-dialog')">Cancel</button>
      <button class="button is-small is-danger" (click)="deletePipeline(pipelineID)">Delete</button>
    </footer>
  </app-confirmation-dialog>
  <app-filter-alert *ngIf="isFilterOrderChanged || isFilterDeleted" (discardChanges)="discardChanges()"
  [filerDialogData]='confirmationDialogData'></app-filter-alert> 